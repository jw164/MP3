<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MP3 Task Manager</title>
  <meta name="description" content="GitHub Pages frontend for MP3 REST API (users/tasks) running on Codespaces." />
  <style>
    :root {
      --primary:#2563eb; --primary-2:#1d4ed8; --bg:#f8fafc; --card:#fff;
      --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --green:#10b981; --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:40px auto;padding:0 16px}
    header{text-align:center;margin-bottom:16px}
    h1{margin:0 0 6px;color:var(--primary)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input[type="url"],input[type="text"]{flex:1 1 260px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none}
    button{padding:10px 14px;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer}
    button:hover{background:var(--primary-2)}
    button.ghost{background:#eef2ff;color:var(--primary-2)}
    .muted{color:var(--muted)}
    .status{display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:999px;background:#cbd5e1;display:inline-block}
    .dot.ok{background:var(--green)} .dot.bad{background:var(--red)}
    .spinner{width:14px;height:14px;border-radius:999px;border:2px solid #cbd5e1;border-top-color:var(--primary);animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
    ul{list-style:none;margin:14px 0 0;padding:0}
    li.task{display:grid;grid-template-columns:28px 1fr auto;gap:10px;align-items:center;border-bottom:1px solid var(--border);padding:10px 6px}
    li.task:last-child{border-bottom:0}
    .empty{text-align:center;color:var(--muted);padding:16px}
    .kpi{display:inline-flex;gap:6px;align-items:center;background:#eff6ff;border:1px solid #dbeafe;border-radius:999px;padding:3px 10px;color:#1e40af;font-size:12px}
    footer{text-align:center;margin:22px 0 8px;color:var(--muted);font-size:13px}
    .err{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px;margin-top:10px}
    .oknote{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:10px;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>MP3 Task Manager</h1>
      <p class="muted">Pages frontend → calls your Codespaces backend (port 3000 set to <b>Public</b>).</p>
    </header>

    <!-- Backend config -->
    <section class="card" aria-label="Backend configuration">
      <div class="row">
        <input id="api" type="url" placeholder="Paste Codespaces public URL, e.g. https://3000-xxxx.github.dev" />
        <button id="save">Save URL</button>
        <button id="copy" class="ghost" title="Copy URL">Copy</button>
        <button id="ping" class="ghost" title="Check backend reachability">Ping</button>
      </div>
      <div class="row" style="margin-top:8px;align-items:center">
        <span class="status">
          <span id="dot" class="dot" aria-hidden="true"></span>
          <span id="stat" class="muted">Idle</span>
        </span>
        <span class="kpi" title="Total tasks"><span>Tasks:</span><b id="count">0</b></span>
      </div>
      <div id="notice" class="muted" style="margin-top:6px;font-size:13px">
        URL is saved in <code>localStorage</code>. You can also pass <code>?api=...</code> in the query string.
      </div>
    </section>

    <!-- Tasks -->
    <section class="card" style="margin-top:14px" aria-label="Tasks">
      <div class="row">
        <input id="newTask" type="text" placeholder="New task name…" />
        <button id="add">Add Task</button>
        <button id="reload" class="ghost">Reload</button>
      </div>
      <ul id="list"><li class="empty">No tasks yet. Click “Reload”.</li></ul>
      <div id="msg" style="display:none"></div>
    </section>

    <footer>
      <div>Frontend: <a href="https://jw164.github.io/MP3/">jw164.github.io/MP3</a></div>
      <div>Make sure your backend is running (Codespaces → <b>npm start</b>) and port 3000 is <b>Public</b>.</div>
    </footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const apiInput = $("api"), dot = $("dot"), stat = $("stat"), list = $("list"), msg = $("msg"), count = $("count");

    // Load API from ?api= or localStorage
    const qs = new URLSearchParams(location.search);
    const saved = localStorage.getItem("mp3_api_base");
    apiInput.value = qs.get("api") || saved || "";

    function apiBase() {
      const v = apiInput.value.trim().replace(/\/$/, "");
      if (!v) throw new Error("Missing API URL");
      return v;
    }
    function note(text, ok=false) {
      msg.style.display = "block";
      msg.className = ok ? "oknote" : "err";
      msg.textContent = text;
      setTimeout(() => (msg.style.display = "none"), 3500);
    }
    function setState(text, cls) {
      stat.textContent = text;
      dot.className = "dot " + (cls || "");
    }

    async function fetchJSON(url, opts = {}, timeout = 15000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeout);
      try {
        const res = await fetch(url, { ...opts, signal: ctrl.signal });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function ping() {
      try {
        setState("Pinging…"); dot.classList.add("spin");
        await fetch(apiBase() + "/api/tasks?limit=1");
        setState("Backend reachable", "ok");
      } catch (e) {
        setState("Backend unreachable", "bad");
        note("Cannot reach backend. Is your Codespaces port 3000 Public? Is CORS enabled on server?", false);
        console.error(e);
      } finally { dot.classList.remove("spin"); }
    }

    async function loadTasks() {
      list.innerHTML = '<li class="empty"><span class="spinner"></span> Loading…</li>';
      try {
        const data = await fetchJSON(apiBase() + '/api/tasks?sort={"dateCreated":-1}');
        const tasks = data.data || [];
        count.textContent = tasks.length;
        if (!tasks.length) { list.innerHTML = '<li class="empty">No tasks found.</li>'; return; }
        list.innerHTML = tasks.map(t => `
          <li class="task">
            <input type="checkbox" ${t.completed ? "checked" : ""} onchange="toggleTask('${t._id}', this.checked)" />
            <div>
              <div>${t.name}</div>
              <div class="muted" style="font-size:12px">id: ${t._id}</div>
            </div>
            <button onclick="removeTask('${t._id}')">Delete</button>
          </li>
        `).join("");
      } catch (e) {
        list.innerHTML = '<li class="empty">Failed to load tasks.</li>';
        count.textContent = "0";
        console.error(e);
      }
    }

    async function addTask() {
      const name = $("newTask").value.trim();
      if (!name) return note("Please enter a task name.");
      try {
        await fetch(apiBase() + "/api/tasks", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ name, deadline: new Date().toISOString() })
        });
        $("newTask").value = "";
        note("Task created.", true);
        loadTasks();
      } catch (e) {
        note("Failed to create task.", false);
        console.error(e);
      }
    }

    async function removeTask(id) {
      if (!confirm("Delete this task?")) return;
      try {
        await fetch(apiBase() + "/api/tasks/" + encodeURIComponent(id), { method:"DELETE" });
        note("Task deleted.", true);
        loadTasks();
      } catch (e) {
        note("Failed to delete task.", false);
        console.error(e);
      }
    }

    async function toggleTask(id, completed) {
      try {
        await fetch(apiBase() + "/api/tasks/" + encodeURIComponent(id), {
          method:"PUT",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ completed })
        });
      } catch (e) {
        note("Failed to update task.", false);
      }
    }
    window.removeTask = removeTask;
    window.toggleTask = toggleTask;

    $("save").onclick = () => {
      try {
        const v = apiBase();
        localStorage.setItem("mp3_api_base", v);
        note("URL saved.", true);
      } catch (e) { note(e.message); }
    };
    $("copy").onclick = async () => {
      try { await navigator.clipboard.writeText(apiInput.value.trim()); note("URL copied.", true); }
      catch { note("Copy failed."); }
    };
    $("ping").onclick = ping;
    $("add").onclick = addTask;
    $("reload").onclick = loadTasks;

    // auto-ping & load if URL present
    if (apiInput.value) { ping().then(loadTasks); }
  </script>
</body>
</html>


